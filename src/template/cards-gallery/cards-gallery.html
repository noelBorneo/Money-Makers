<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cards Gallery</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.css" />
	<script src="../../node_modules/web3/dist/web3.min.js"></script> 
  <script src="../../solidity/contracts.json"></script>   
   <link rel="stylesheet" href="cards-gallery.css">
</head>
<body>
   <section class="gallery-block cards-gallery">
	    <div class="container">
	        <div class="heading">
	          <h2>Investor's Marketplace</h2>
	        	<button id="addToArray" class="btn" onclick="pushObject(defaultObject)" > Borrow Requests </button>
	        	<button id="lend" class="btn btn-success" onclick="lendMoney()"> Lend Some Money! </button>
      	    <button id="requestLend" class="btn " onclick="requestLend()"> Request Some Money! </button>

	        	</div>
	        <div id="borrowers" class="row">
	        </div>
	    </div>
    </section>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  		<script>
    		
			defaultObject = {"name": "Jamm", "address": "hahaha", "requiredAmount": 30, "coin": "ETH", "paybackTimeInDays": 50, "interestPercentage":40};

      lendings = [{"name":"Mickey Spence", "address":"0x000111232332332", "requiredAmount":35, "coin":"ETH", "paybackTimeInDays":77, "interestPercentage":14}];

  		if(typeof web3 !== 'undefined') {
	    		web3 = new Web3(web3.currentProvider);
	    	} else {
	    		web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
	    	}

	    	web3.eth.defaultAccount = web3.eth.accounts[0];

	    	var LendingContract = web3.eth.contract(LendingsContractABI);

	    	var Lendings = LendingContract.at('0xb12345123312fcbedc8532ba1385218cf28326c7');

	    	// We're using the instructorEvent (Coursro.Instuctor()) defined in the solidity smart comtract
	    	var borrowingEvent = Lendings.showContractDetails({}, 'latest');

	    	borrowingEvent.watch(function(error, result){
	    		if(!error){
						pushObject({"name":"Default Name", "address":result.args.contractAddress, "requiredAmount":result.args.borrowAmount, "coin":"ETH", "paybackTime":result.args.paybackTime, "interestPercentage":result.args.interest});

						console.log("lendings is: ", lendings);
						console.log(JSON.stringify(lendings));
						console.log("Event emmited!");

	    		} else {
	    			cosole.log("Error emitting event");
	    		}
    		});


	    	function pushObject(borrowObj){
      		lendings.push(borrowObj);
      		populate();
	    	}

	    	function getProgressOfLoan(address){
		    	var SingleLendingContract = web3.eth.contract(SingleLendingABI);
		    	var SLInstance = SingleLendingContract.at(address);

		    	SLInstance.getTotalLendedAmount((error, result) => {
		    		if(error){
    					console.log("Error when getting total lended amount");
		    		} else {
		    			var lendedAmount = result;
		    			SLInstance.getRequestedAmount((err, res) => {
		    				if(err){
		    					console.log("Error when getting requested amount");
		    				} else {
		    					var loanedRatio = lendedAmount/res;
		    					return loanedRatio;
		    				}
		    			});
		    		}
		    	});

	    	}

	    	function lendMoney(val, address){
		    	var SingleLendingContract = web3.eth.contract(SingleLendingABI);
		    	var SLInstance = SingleLendingContract.at(address);

	    		SLInstance.lend({from:web3.eth.defaultAccount, 
	    			value: web3.toWei(val, "ether")}, (error, result) => {
	    			if(error){
		    			$("#loader").hide();
		    			$('#error').text("Error, mate!");
		    		} else {
		    			console.log("Lending some money!!");
		    		}
	    		});
    		}

        baguetteBox.run('.cards-gallery', { animation: 'slideIn'});
        
        function getAllLendingContracts(){
        	return lendings;
        }

        function populate() {
        	var borrowers = document.getElementById("borrowers");
        	borrowers.innerHTML = "";
      		var len = lendings.length;
	        for (var i = len - 1; i >= 0; i--) {
	        	console.log("In populate, lendings "+i+" is ", lendings[i])

	        	var parentDiv = document.createElement("div");
	        	parentDiv.id = lendings[i]["address"];
	        	parentDiv.className = "col-md-6 col-lg-4";

	        	var borderDiv = document.createElement("div");
	        	borderDiv.className = "card border-0 transform-on-hover";

	        	parentDiv.appendChild(borderDiv);

						var cardDiv = document.createElement("div");
	        	cardDiv.className = "card-body";
	        	borderDiv.appendChild(cardDiv);

	        	var nameElement = document.createElement("h5");
	        	nameElement.textContent = lendings[i]["name"];
	        	cardDiv.appendChild(nameElement);

						var addressP = document.createElement("p");
	        	addressP.className = "subtitle";
	        	addressP.textContent = "Address: "+ lendings[i]["address"];
	        	cardDiv.appendChild(addressP);

						var amount = document.createElement("p");
	        	amount.className = "";
	        	amount.textContent = "Amount: "+ lendings[i]["requiredAmount"]+" "+lendings[i]["coin"];
	        	cardDiv.appendChild(amount);

						var amount = document.createElement("p");
	        	amount.className = "";
	        	amount.textContent = "Payback Time in Days: "+ lendings[i]["paybackTimeInDays"];
	        	cardDiv.appendChild(amount);
						
						var amount = document.createElement("p");
	        	amount.className = "";
	        	amount.textContent = "Interest: "+ lendings[i]["interestPercentage"];
	        	cardDiv.appendChild(amount);


	        	var progressBar = document.createElement("div");
	        	progressBar.className="progress-bar";
	        	var progressed = document.createElement("div");
	        	progressed.className="progressed";
	        	progressBar.appendChild(progressed);
	        	cardDiv.appendChild(progressBar);

						var bttn = document.createElement("button");
						bttn.id = lendings[i]["address"];
	        	bttn.className = "btn btn-success";
	        	bttn.textContent = "Fund This";

	        	bttn.onclick = (function(iter, array, elem) {return function(){
			    		alert("Are you sure you want to fund this person? ");
							console.log(iter);
							console.log(array[iter]);
			    		lendMoney(1, array[iter]["address"]);
							elem.style.width = getProgressOfLoan(array[iter]['address']) * 100 + '%';

	        	}})(i, lendings, progressed);
	        	cardDiv.appendChild(bttn);

	        	borrowers.appendChild(parentDiv);
	        }
	      }

      	
	    </script>
</body>
</html>
